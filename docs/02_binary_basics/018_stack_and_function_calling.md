# 018 栈和函数调用

# 1. 栈

栈是一个很重要的数据结构，它的特征是后进先出。

在程序中，栈是一块内存区域，其中栈顶指针的值在 `ss:esp` 寄存器中，栈是从高地址向低地址增长的。

## 2. 操作指令

相关的操作指令为 `push` 和 `pop`，还有它们的衍生指令。（下面的操作数 x 可以是寄存器、内存地址、立即数）

- `push $x`：将操作数 x 压入栈
- `pop $x`：将栈顶的数据弹出栈，存储到操作数 x 中

8 个基础寄存器分别为 `eax ecx edx ebx esp ebp esi edi`。

- `pusha`：将 8 个基础寄存器按以上的顺序压入栈中
- `popa`：将 7 个基础寄存器依次弹出，与 `pusha` 相对，会忽略 esp

## 3. 函数调用约定

- `call`：会将 `call` 返回的下一条指令地址压入栈中
- `ret`：将栈顶的数据弹出到 `eip` 寄存器中
- `call` 和 `ret` 无关

## 4. 代码分析

```x86asm
/* tests/call.asm */

[bits 32]

extern exit

test:
    ; 4. 测试单独使用 ret 指令
    ; push $
    ret

global main
main:
    ; 1. 测试基本的 push 和 pop 指令
    ; push 5
    ; push eax

    ; pop ebx
    ; pop ecx

    ; 2. 测试 pusha 和 popa 指令
    ; pusha
    ; popa

    ; 3. 测试 call 和 ret 指令联合使用
    call test

    push 0 ; 传递参数
    call exit
```

在调试器中调试验证指令的作用。

## 5. 调试支持

为了能使用 gdb 来调试 nasm 风格的汇编程序，需要对调试配置文件进行一些修改。原理为将 nasm 风格的汇编程序，用 gcc 转化成 gcc 风格的汇编程序。 

在 `launch.json` 中新增一个调试选项 `nasm - Build and debug active file`：

```json
/* .vscode/launch.json */

{
    "name": "nasm - Build and debug active file",
    "type": "cppdbg",
    "request": "launch",
    "program": "${fileDirname}/${fileBasenameNoExtension}.out",
    "args": [],
    "stopAtEntry": false,
    "cwd": "${fileDirname}",
    "environment": [],
    "externalConsole": false,
    "MIMode": "gdb",
    "setupCommands": [
        {
            "description": "Enable pretty-printing for gdb",
            "text": "-enable-pretty-printing",
            "ignoreFailures": true
        },
        {
            "description": "Set Disassembly Flavor to Intel",
            "text": "-gdb-set disassembly-flavor intel",
            "ignoreFailures": true
        }
    ],
    "preLaunchTask": "nasm: gcc build active file",
    "miDebuggerPath": "/usr/bin/gdb"
}
```

并按照其中的 `preLaunchTask`，在 `tasks.json` 中新增一个 task `nasm: gcc build active file`：

```json
/* .vscode/tasks.json */

{
    "type": "shell",
    "label": "nasm: gcc build active file",
    "command": "",
    "args": [
        "/usr/bin/nasm",
        "-f",
        "elf32",
        "-g",
        "${file}",
        "-o",
        "${fileDirname}/${fileBasenameNoExtension}.o",
        ";",
        "/usr/bin/gcc",
        "-fdiagnostics-color=always",
        "-m32", // 编译成 32 位的程序
        "-g",
        "-static",
        "-I${workspaceFolder}/src/include",
        "${fileDirname}/${fileBasenameNoExtension}.o",
        "-o",
        "${fileDirname}/${fileBasenameNoExtension}.out"
    ],
    "options": {
        "cwd": "${fileDirname}"
    },
    "problemMatcher": [
        "$gcc"
    ],
    "group": {
        "kind": "build",
        "isDefault": true
    },
    "detail": "Task generated by Debugger."
}
```