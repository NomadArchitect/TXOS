# 002 配置开发环境

## 1. VMware + Arch Linux

> 注：Arch Linux 目前已经弃用 `ifcinfig` 命令了，请使用 `ip addr` 命令来代替使用。

- [安装 VMware - bilibili][wmware-install]
- [在 VMWare 虚拟机中安装 Archlinux - bilibili][arch-install]
- [安装 Gnome 图形界面 - bilibili][gnome-install]
- [VMware 配置 Archlinux 自适应分辨率 - bilibili][arch-resolution]

> 注：如果虚拟机出现明显卡顿的话，可以参考这篇文章 [<VMware 基本设置 - CSDN>][vmware-setting]。

## 2. VS Code

- [安装 VScode - bilibili][vscode-install]
- [VSCode 配置远程开发环境 - bilibili][vscode-ssh-01]
- [VS Code 使用 SSH 远程免密连接虚拟机 - zhihu][vscode-ssh-02]
- VS Code 插件：
    - [ASM Code Lens][asm-code-lens]
    - [C/C++][cpp-tools]
    - [Hex Editor][hex-editor]
    - [Git Lens][git-lens]

> 注1：如果在使用 VS Code 还是出现 **“试图写入的管道不存在”** 的报错，参考这篇文章 [<Vscode SSH连接远端出的“过程试图写入的管道不存在”解决办法 - CSDN>][vscode-ssh-03] 来解决。

> 注2：如果你之前安装了 clangd 插件，并且设置了 `"C_Cpp.intelliSenseEngine": "disable"`，而你需要在本项目使用 C/C++ 插件的话，需要对本项目创建一个工作区 (workspace)，然后在工作区的 `setting.json` 文件（一般位于工作区的 `.vscode/` 目录下），添加 `"C_Cpp.intelliSenseEngine": "default",` 即可。

## 3. NASM

在 Arch Linux 上安装 NASM 编译器：

```bash
sudo pacman -S nasm
```

## 4. Bochs

[Bochs][bochs] 是一款 x86 架构的模拟器，可能是由于流行度过低，应该是没人维护了，所以从 Community Repository 中被移除了，最后有人重新上传到了 [AUR][aur]，导致所以无法使用 `pacman` 来安装包。

这种情况下，可以使用 `makepkg` 来安装，通过 `wget` 下载 bochs 的程序包。

```bash
# 如果没有安装 wget，则通过以下命令来安装
sudo pacman -S wget

# 获取 bochs 的程序包
wget https://aur.archlinux.org/cgit/aur.git/snapshot/bochs.tar.gz
```

然后执行解压缩：

```bash
tar -xvf bochs.tar.gz
```

接着进入 bochs 目录，执行如下命令，安装 bochs：

```bash
makepkg -si
```

> 注：由于 bochs-gdb 本身就在 aur 中，所以 [<015 Bochs GDB 调试>][015_bochs_gdb] 的内容应该不受影响。

## 5. GDB

目前我们的 Arch Linux 中还没有 gdb，通过以下命令来安装：

```bash
sudo pacman -S gdb
```

## 6. 引导代码

在 `boot.asm` 中编写内核引导代码：

```x86asm
[org 0x7c00]

; 设置屏幕模式为文本模式，并清除屏幕
mov ax, 3
int 0x10

; 初始化所有的段寄存器
mov ax, 0
mov ds, ax
mov es, ax
mov ss, ax
mov sp, 0x7c00

; 0xb8000 是文本显示器的内存映射区域
mov ax, 0xb800
mov ds, ax
mov byte [0], 'H'
mov byte [2], 'e'
mov byte [4], 'l'
mov byte [6], 'l'
mov byte [8], 'o'
mov byte [10], ','
mov byte [12], ' '
mov byte [14], 'X'
mov byte [24], 'O'
mov byte [26], 'S'
mov byte [28], '!'

; 程序结束，进行阻塞
jmp $

; 填充 0
times 510 - ($ - $$) db 0

; 主引导扇区的最后两个字节必须是 0x55 和 0xaa
; x86 的内存是小段模式
dw 0xaa55
```

并使用 NASM 编译器进行编译：

```bash
nasm -f bin boot.asm -o boot.bin
```

## 7. 创建硬盘镜像

按照以下命令创建 img 格式的硬盘镜像，并将 `boot.bin` 写入到主引导扇区（即第一个扇区）。这里面每个扇区大小均为 512 MB。

```bash
# 创建硬盘镜像
bximage -q -hd=16 -func=create -sectsize=512 -imgmode=flat master.img

# 将 boot.bin 写入主引导扇区
dd if=boot.bin of=master.img bs=512 count=1 conv=notrunc
```

`bximage` 是 bochs 的一个工具，用于生成虚拟软盘、虚拟硬盘或者磁盘映像。

|  参数   | 说明 |
| :----: | :--: |
|   hd   | 硬盘映像，-hd=16 表示创建 16 MB 的硬盘映像 |
| func   | create 表示创建映像 |
| sectsize | 扇区大小（以字节为单位） |
| imgmode | 映像格式（flat 格式可方便我们使用 Hex Editor 查看） |
| master.img | 输出的映像文件名 |


Linux 的 `dd` 命令 可以从标准输入或者文件中，读取数据，并根据指定的格式来转换数据，在输出到标准输出、文件或者设备当中。

|  参数  | 说明 |
| :---: | :--: |
|   if  | 输入文件名 | 
|   of  | 输出文件名 |
|   bs  | 块的大小（以字节为单位） |
| count | 拷贝的块个数，其中块的大小由参数 bs 来指定 |
| conv  | notrunc 表示不截短输出文件 |

> 注：不截短输出文件表示：如果输出文件大小小于先前生成的磁盘映像的大小，则维持原有的磁盘映像的大小。如果不加这个关键字，则会改变磁盘映像的大小为输出文件的大小。

## 8. 配置 Bochs

通过执行 `bochs` 命令，并依次选择 `Save options to...`，输入 `bochsrc`，选择 `Quit now`。获得 bochs 配置文件的模板（即我们先前输入的 bochsrc 文件）。

我们将这个配置文件改成如下（也可直接省略先前的步骤，直接复制些内容到 bochsrc 文件）：

```ini
# configuration file generated by Bochs
plugin_ctrl: unmapped=true, biosdev=true, speaker=true, extfpuirq=true, parallel=true, serial=true, iodebug=true, pcidev=false, usb_uhci=false
config_interface: textconfig
display_library: x, options="gui_debug"
memory: host=32, guest=32
romimage: file="/usr/share/bochs/BIOS-bochs-latest", address=0x00000000, options=none
vgaromimage: file="/usr/share/bochs/VGABIOS-lgpl-latest"
boot: disk
floppy_bootsig_check: disabled=0
floppya: type=1_44
# no floppyb
ata0: enabled=true, ioaddr1=0x1f0, ioaddr2=0x3f0, irq=14
ata0-master: type=disk, path="master.img", mode=flat
ata0-slave: type=none
ata1: enabled=true, ioaddr1=0x170, ioaddr2=0x370, irq=15
ata1-master: type=none
ata1-slave: type=none
ata2: enabled=false
ata3: enabled=false
optromimage1: file=none
optromimage2: file=none
optromimage3: file=none
optromimage4: file=none
optramimage1: file=none
optramimage2: file=none
optramimage3: file=none
optramimage4: file=none
pci: enabled=1, chipset=i440fx, slot1=none, slot2=none, slot3=none, slot4=none, slot5=none
vga: extension=vbe, update_freq=5, realtime=1, ddc=builtin
cpu: count=1:1:1, ips=4000000, quantum=16, model=bx_generic, reset_on_triple_fault=1, cpuid_limit_winnt=0, ignore_bad_msrs=1, mwait_is_nop=0
cpuid: level=6, stepping=3, model=3, family=6, vendor_string="AuthenticAMD", brand_string="AMD Athlon(tm) processor"
cpuid: mmx=true, apic=xapic, simd=sse2, sse4a=false, misaligned_sse=false, sep=true
cpuid: movbe=false, adx=false, aes=false, sha=false, xsave=false, xsaveopt=false, avx_f16c=false
cpuid: avx_fma=false, bmi=0, xop=false, fma4=false, tbm=false, x86_64=true, 1g_pages=false
cpuid: pcid=false, fsgsbase=false, smep=false, smap=false, mwait=true
print_timestamps: enabled=0
debugger_log: -
magic_break: enabled=0
port_e9_hack: enabled=0
private_colormap: enabled=0
clock: sync=none, time0=local, rtc_sync=0
# no cmosimage
log: -
logprefix: %t%e%d
debug: action=ignore
info: action=report
error: action=report
panic: action=ask
keyboard: type=mf, serial_delay=250, paste_delay=100000, user_shortcut=none
mouse: type=ps2, enabled=false, toggle=ctrl+mbutton
speaker: enabled=true, mode=system
parport1: enabled=true, file=none
parport2: enabled=false
com1: enabled=true, mode=null
com2: enabled=false
com3: enabled=false
com4: enabled=false
```

主要部分的解释：

| 配置 | 说明 |
| :--: | :--: |
| - `ata0-master: type=disk, path="master.img", mode=flat` | 主盘是硬盘（disk），硬盘映像的路径为 `master.img`，硬盘映像的格式为 `flat`，均与先前创建的硬盘映像的参数一致 |
| `boot: disk` | 启动模式为，从硬盘（disk）启动 |
| `display_library: x, options="gui_debug"` | 调试模式是 GUI，即使用图形界面调试 |

## 9. 运行测试

我们尝试使用 Bochs 来运行测试我们的引导程序。

预期为，在屏幕打印 `“Hello, XOS!'`。



[wmware-install]: https://www.bilibili.com/video/BV1iz4y117wY/?spm_id_from=333.999.0.0
[arch-install]: https://www.bilibili.com/video/BV1Pi4y1K7DS/?spm_id_from=333.999.0.0
[gnome-install]: https://www.bilibili.com/video/BV1df4y147Cq/?spm_id_from=333.999.0.0
[arch-resolution]: https://www.bilibili.com/video/BV1tZ4y1w7fR/?spm_id_from=333.999.0.0
[vmware-setting]: https://blog.csdn.net/z609932088/article/details/128551628

[vscode-install]: https://www.bilibili.com/video/BV1Yo4y1Z72E/?spm_id_from=333.999.0.0
[vscode-ssh-01]: https://www.bilibili.com/video/BV1kQ4y1Z7ff/?spm_id_from=333.999.0.0
[vscode-ssh-02]: https://zhuanlan.zhihu.com/p/652476986o
[vscode-ssh-03]: https://blog.csdn.net/weixin_48408892/article/details/129209615

[asm-code-lens]: https://marketplace.visualstudio.com/items?itemName=maziac.asm-code-lens
[cpp-tools]: https://marketplace.visualstudio.com/items?itemName=ms-vscode.cpptools
[hex-editor]:https://marketplace.visualstudio.com/items?itemName=ms-vscode.hexeditor
[git-lens]: https://marketplace.visualstudio.com/items?itemName=eamodio.gitlens

[bochs]: https://bochs.sourceforge.io/
[aur]: https://aur.archlinux.org/packages/bochs

[015_bochs_gdb]: ../02_binary_basics/015_bochs_gdb.md
